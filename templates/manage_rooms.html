{% extends "base.html" %}

{% block title %}Manage Rooms - SmartTable{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Manage Rooms</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="container-fluid">
        <h1><i class="fas fa-door-open me-3"></i>Manage Rooms</h1>
        <p>Add, edit, and manage all your rooms</p>
    </div>
</div>

<!-- Add Room Button -->
<div class="row mb-4">
    <div class="col-12">
        <button class="add-btn" data-bs-toggle="modal" data-bs-target="#roomModal">
            <i class="fas fa-plus"></i> Add New Room
        </button>
    </div>
</div>

<!-- Rooms Table -->
<div class="row">
    <div class="col-12">
        <div class="data-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Room Number</th>
                        <th>Capacity</th>
                        <th>Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="roomsTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Empty State -->
<div id="emptyState" class="empty-state" style="display: none;">
    <div class="icon">
        <i class="fas fa-door-open"></i>
    </div>
    <h3>No Rooms Found</h3>
    <p>Start by adding your first room to get started.</p>
</div>

<!-- Room Modal -->
<div class="modal fade" id="roomModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roomModalTitle">Add New Room</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="roomForm">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="roomNumber" placeholder="Room Number" required>
                        <label for="roomNumber">Room Number</label>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-floating">
                        <input type="number" class="form-control" id="roomCapacity" placeholder="Capacity" min="10" max="100" required>
                        <label for="roomCapacity">Capacity</label>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-floating">
                        <select class="form-select" id="roomType" required>
                            <option value="">Select Type</option>
                            <option value="Theory">Theory</option>
                            <option value="Lab">Lab</option>
                        </select>
                        <label for="roomType">Room Type</label>
                        <div class="invalid-feedback"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRoomBtn">
                    <span class="spinner" style="display: none;"></span>
                    <span class="btn-text">Save Room</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// Global variables
let rooms = [];
let editingRoomId = null;

// Load rooms on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRooms();
    
    // Form submission
    document.getElementById('saveRoomBtn').addEventListener('click', saveRoom);
    
    // Modal events
    document.getElementById('roomModal').addEventListener('hidden.bs.modal', resetForm);
});

// Load rooms from API
async function loadRooms() {
    try {
        showLoading();
        const response = await fetch('/api/rooms');
        rooms = await response.json();
        renderRooms();
    } catch (error) {
        showToast('Error loading rooms', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Render rooms in table
function renderRooms() {
    const tbody = document.getElementById('roomsTableBody');
    const emptyState = document.getElementById('emptyState');
    
    if (rooms.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    tbody.innerHTML = rooms.map(room => `
        <tr>
            <td><strong>${room.room_number}</strong></td>
            <td><span class="badge bg-primary">${room.capacity}</span></td>
            <td><span class="badge ${room.room_type === 'Theory' ? 'bg-info' : 'bg-warning'}">${room.room_type}</span></td>
            <td>
                <button class="btn-edit" onclick="editRoom('${room.id}')">
                    <i class="fas fa-edit me-1"></i>Edit
                </button>
                <button class="btn-delete" onclick="deleteRoom('${room.id}')">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </td>
        </tr>
    `).join('');
}

// Edit room
function editRoom(roomId) {
    const room = rooms.find(r => r.id === roomId);
    if (!room) return;
    
    editingRoomId = roomId;
    document.getElementById('roomModalTitle').textContent = 'Edit Room';
    document.getElementById('roomNumber').value = room.room_number;
    document.getElementById('roomCapacity').value = room.capacity;
    document.getElementById('roomType').value = room.room_type;
    
    new bootstrap.Modal(document.getElementById('roomModal')).show();
}

// Delete room
async function deleteRoom(roomId) {
    if (!confirm('Are you sure you want to delete this room?')) return;
    
    try {
        showLoading();
        const response = await fetch(`/api/rooms/${roomId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Room deleted successfully', 'success');
            loadRooms();
        } else {
            showToast('Error deleting room', 'error');
        }
    } catch (error) {
        showToast('Error deleting room', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Save room
async function saveRoom() {
    if (!validateForm()) return;
    
    const formData = {
        room_number: document.getElementById('roomNumber').value,
        capacity: parseInt(document.getElementById('roomCapacity').value),
        room_type: document.getElementById('roomType').value
    };
    
    try {
        showLoading();
        const url = editingRoomId ? `/api/rooms/${editingRoomId}` : '/api/rooms';
        const method = editingRoomId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const message = editingRoomId ? 'Room updated successfully' : 'Room added successfully';
            showToast(message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('roomModal')).hide();
            loadRooms();
        } else {
            showToast('Error saving room', 'error');
        }
    } catch (error) {
        showToast('Error saving room', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Validate form
function validateForm() {
    let isValid = true;
    const fields = ['roomNumber', 'roomCapacity', 'roomType'];
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const value = field.value.trim();
        
        if (!value) {
            field.classList.add('is-invalid');
            field.classList.remove('is-valid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        }
    });
    
    return isValid;
}

// Reset form
function resetForm() {
    document.getElementById('roomForm').reset();
    document.querySelectorAll('.form-control, .form-select').forEach(field => {
        field.classList.remove('is-valid', 'is-invalid');
    });
    editingRoomId = null;
    document.getElementById('roomModalTitle').textContent = 'Add New Room';
}

// Show loading
function showLoading() {
    const spinner = document.querySelector('#saveRoomBtn .spinner');
    const btnText = document.querySelector('#saveRoomBtn .btn-text');
    if (spinner && btnText) {
        spinner.style.display = 'inline-block';
        btnText.textContent = 'Saving...';
    }
}

// Hide loading
function hideLoading() {
    const spinner = document.querySelector('#saveRoomBtn .spinner');
    const btnText = document.querySelector('#saveRoomBtn .btn-text');
    if (spinner && btnText) {
        spinner.style.display = 'none';
        btnText.textContent = 'Save Room';
    }
}

// Show toast notification
function showToast(message, type) {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const toastHtml = `
        <div class="toast ${type}" id="${toastId}" role="alert">
            <div class="toast-header">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
</script>
{% endblock %}