{% extends "base.html" %}

{% block title %}Manage Courses - SmartTable{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Manage Courses</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="container-fluid">
        <h1><i class="fas fa-book me-3"></i>Manage Courses</h1>
        <p>Add, edit, and manage all your courses</p>
    </div>
</div>

<!-- Add Course Button -->
<div class="row mb-4">
    <div class="col-12">
        <button class="add-btn" data-bs-toggle="modal" data-bs-target="#courseModal">
            <i class="fas fa-plus"></i> Add New Course
        </button>
    </div>
</div>

<!-- Courses Table -->
<div class="row">
    <div class="col-12">
        <div class="data-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Course Code</th>
                        <th>Course Name</th>
                        <th>Sessions/Week</th>
                        <th>Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="coursesTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Empty State -->
<div id="emptyState" class="empty-state" style="display: none;">
    <div class="icon">
        <i class="fas fa-book"></i>
    </div>
    <h3>No Courses Found</h3>
    <p>Start by adding your first course to get started.</p>
</div>

<!-- Course Modal -->
<div class="modal fade" id="courseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="courseModalTitle">Add New Course</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="courseForm">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="courseCode" placeholder="Course Code" required>
                        <label for="courseCode">Course Code</label>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-floating">
                        <input type="text" class="form-control" id="courseName" placeholder="Course Name" required>
                        <label for="courseName">Course Name</label>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-floating">
                        <input type="number" class="form-control" id="sessionsPerWeek" placeholder="Sessions Per Week" min="1" max="6" required>
                        <label for="sessionsPerWeek">Sessions Per Week</label>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-floating">
                        <select class="form-select" id="courseType" required>
                            <option value="">Select Type</option>
                            <option value="Theory">Theory</option>
                            <option value="Lab">Lab</option>
                        </select>
                        <label for="courseType">Course Type</label>
                        <div class="invalid-feedback"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCourseBtn">
                    <span class="spinner" style="display: none;"></span>
                    <span class="btn-text">Save Course</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// Global variables
let courses = [];
let editingCourseId = null;

// Load courses on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCourses();
    
    // Form submission
    document.getElementById('saveCourseBtn').addEventListener('click', saveCourse);
    
    // Modal events
    document.getElementById('courseModal').addEventListener('hidden.bs.modal', resetForm);
});

// Load courses from API
async function loadCourses() {
    try {
        showLoading();
        const response = await fetch('/api/courses');
        courses = await response.json();
        renderCourses();
    } catch (error) {
        showToast('Error loading courses', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Render courses in table
function renderCourses() {
    const tbody = document.getElementById('coursesTableBody');
    const emptyState = document.getElementById('emptyState');
    
    if (courses.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    tbody.innerHTML = courses.map(course => `
        <tr>
            <td><strong>${course.code}</strong></td>
            <td>${course.name}</td>
            <td><span class="badge bg-primary">${course.sessions_per_week}</span></td>
            <td><span class="badge ${course.course_type === 'Theory' ? 'bg-info' : 'bg-warning'}">${course.course_type}</span></td>
            <td>
                <button class="btn-edit" onclick="editCourse('${course.id}')">
                    <i class="fas fa-edit me-1"></i>Edit
                </button>
                <button class="btn-delete" onclick="deleteCourse('${course.id}')">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </td>
        </tr>
    `).join('');
}

// Edit course
function editCourse(courseId) {
    const course = courses.find(c => c.id === courseId);
    if (!course) return;
    
    editingCourseId = courseId;
    document.getElementById('courseModalTitle').textContent = 'Edit Course';
    document.getElementById('courseCode').value = course.code;
    document.getElementById('courseName').value = course.name;
    document.getElementById('sessionsPerWeek').value = course.sessions_per_week;
    document.getElementById('courseType').value = course.course_type;
    
    new bootstrap.Modal(document.getElementById('courseModal')).show();
}

// Delete course
async function deleteCourse(courseId) {
    const course = courses.find(c => c.id === courseId);
    const courseName = course ? course.name : 'this course';
    
    if (!confirm(`Are you sure you want to delete "${courseName}"?\n\nThis action cannot be undone.`)) return;
    
    try {
        showLoading();
        const response = await fetch(`/api/courses/${courseId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Course deleted successfully!', 'success');
            loadCourses();
        } else {
            const result = await response.json();
            showToast(result.message || 'Error deleting course', 'error');
        }
    } catch (error) {
        showToast('Error deleting course', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Save course
async function saveCourse() {
    if (!validateForm()) return;
    
    const formData = {
        code: document.getElementById('courseCode').value,
        name: document.getElementById('courseName').value,
        sessions_per_week: parseInt(document.getElementById('sessionsPerWeek').value),
        course_type: document.getElementById('courseType').value
    };
    
    try {
        showLoading();
        const url = editingCourseId ? `/api/courses/${editingCourseId}` : '/api/courses';
        const method = editingCourseId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const message = editingCourseId ? 'Course updated successfully!' : 'Course added successfully!';
            showToast(message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('courseModal')).hide();
            loadCourses();
        } else {
            const result = await response.json();
            showToast(result.message || 'Error saving course', 'error');
        }
    } catch (error) {
        showToast('Error saving course', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Validate form
function validateForm() {
    let isValid = true;
    const fields = ['courseCode', 'courseName', 'sessionsPerWeek', 'courseType'];
    
    // Clear previous validation
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.classList.remove('is-valid', 'is-invalid');
        const feedback = field.parentNode.querySelector('.invalid-feedback');
        if (feedback) feedback.textContent = '';
    });
    
    // Validate course code
    const courseCode = document.getElementById('courseCode').value.trim();
    if (!courseCode) {
        showFieldError('courseCode', 'Course code is required');
        isValid = false;
    } else if (courseCode.length < 2) {
        showFieldError('courseCode', 'Course code must be at least 2 characters');
        isValid = false;
    } else {
        showFieldSuccess('courseCode');
    }
    
    // Validate course name
    const courseName = document.getElementById('courseName').value.trim();
    if (!courseName) {
        showFieldError('courseName', 'Course name is required');
        isValid = false;
    } else if (courseName.length < 3) {
        showFieldError('courseName', 'Course name must be at least 3 characters');
        isValid = false;
    } else {
        showFieldSuccess('courseName');
    }
    
    // Validate sessions per week
    const sessionsPerWeek = parseInt(document.getElementById('sessionsPerWeek').value);
    if (!sessionsPerWeek || sessionsPerWeek < 1 || sessionsPerWeek > 6) {
        showFieldError('sessionsPerWeek', 'Sessions per week must be between 1 and 6');
        isValid = false;
    } else {
        showFieldSuccess('sessionsPerWeek');
    }
    
    // Validate course type
    const courseType = document.getElementById('courseType').value;
    if (!courseType) {
        showFieldError('courseType', 'Course type is required');
        isValid = false;
    } else {
        showFieldSuccess('courseType');
    }
    
    return isValid;
}

// Show field error
function showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    field.classList.add('is-invalid');
    field.classList.remove('is-valid');
    
    let feedback = field.parentNode.querySelector('.invalid-feedback');
    if (!feedback) {
        feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        field.parentNode.appendChild(feedback);
    }
    feedback.textContent = message;
}

// Show field success
function showFieldSuccess(fieldId) {
    const field = document.getElementById(fieldId);
    field.classList.add('is-valid');
    field.classList.remove('is-invalid');
}

// Reset form
function resetForm() {
    document.getElementById('courseForm').reset();
    document.querySelectorAll('.form-control, .form-select').forEach(field => {
        field.classList.remove('is-valid', 'is-invalid');
    });
    editingCourseId = null;
    document.getElementById('courseModalTitle').textContent = 'Add New Course';
}

// Show loading
function showLoading() {
    const spinner = document.querySelector('#saveCourseBtn .spinner');
    const btnText = document.querySelector('#saveCourseBtn .btn-text');
    if (spinner && btnText) {
        spinner.style.display = 'inline-block';
        btnText.textContent = 'Saving...';
    }
}

// Hide loading
function hideLoading() {
    const spinner = document.querySelector('#saveCourseBtn .spinner');
    const btnText = document.querySelector('#saveCourseBtn .btn-text');
    if (spinner && btnText) {
        spinner.style.display = 'none';
        btnText.textContent = 'Save Course';
    }
}

// Show toast notification
function showToast(message, type) {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const toastHtml = `
        <div class="toast ${type}" id="${toastId}" role="alert">
            <div class="toast-header">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
</script>
{% endblock %}