{% extends "base.html" %}

{% block title %}Manage Teachers - SmartTable{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Manage Teachers</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="container-fluid">
        <h1><i class="fas fa-user me-3"></i>Manage Teachers</h1>
        <p>Add, edit, and manage all your teachers</p>
    </div>
</div>

<!-- Add Teacher Button -->
<div class="row mb-4">
    <div class="col-12">
        <button class="add-btn" data-bs-toggle="modal" data-bs-target="#teacherModal">
            <i class="fas fa-plus"></i> Add New Teacher
        </button>
    </div>
</div>

<!-- Teachers Table -->
<div class="row">
    <div class="col-12">
        <div class="data-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="teachersTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Empty State -->
<div id="emptyState" class="empty-state" style="display: none;">
    <div class="icon">
        <i class="fas fa-user"></i>
    </div>
    <h3>No Teachers Found</h3>
    <p>Start by adding your first teacher to get started.</p>
</div>

<!-- Teacher Modal -->
<div class="modal fade" id="teacherModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teacherModalTitle">Add New Teacher</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="teacherForm">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="teacherName" placeholder="Teacher Name" required>
                        <label for="teacherName">Teacher Name</label>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-floating">
                        <select class="form-select" id="teacherDepartment" required>
                            <option value="">Select Department</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Mechanical">Mechanical</option>
                            <option value="Civil">Civil</option>
                        </select>
                        <label for="teacherDepartment">Department</label>
                        <div class="invalid-feedback"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTeacherBtn">
                    <span class="spinner" style="display: none;"></span>
                    <span class="btn-text">Save Teacher</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// Global variables
let teachers = [];
let editingTeacherId = null;

// Load teachers on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTeachers();
    
    // Form submission
    document.getElementById('saveTeacherBtn').addEventListener('click', saveTeacher);
    
    // Modal events
    document.getElementById('teacherModal').addEventListener('hidden.bs.modal', resetForm);
});

// Load teachers from API
async function loadTeachers() {
    try {
        showLoading();
        const response = await fetch('/api/teachers');
        teachers = await response.json();
        renderTeachers();
    } catch (error) {
        showToast('Error loading teachers', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Render teachers in table
function renderTeachers() {
    const tbody = document.getElementById('teachersTableBody');
    const emptyState = document.getElementById('emptyState');
    
    if (teachers.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    tbody.innerHTML = teachers.map(teacher => `
        <tr>
            <td><strong>${teacher.name}</strong></td>
            <td><span class="badge bg-info">${teacher.department}</span></td>
            <td>
                <button class="btn-edit" onclick="editTeacher('${teacher.id}')">
                    <i class="fas fa-edit me-1"></i>Edit
                </button>
                <button class="btn-delete" onclick="deleteTeacher('${teacher.id}')">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </td>
        </tr>
    `).join('');
}

// Edit teacher
function editTeacher(teacherId) {
    const teacher = teachers.find(t => t.id === teacherId);
    if (!teacher) return;
    
    editingTeacherId = teacherId;
    document.getElementById('teacherModalTitle').textContent = 'Edit Teacher';
    document.getElementById('teacherName').value = teacher.name;
    document.getElementById('teacherDepartment').value = teacher.department;
    
    new bootstrap.Modal(document.getElementById('teacherModal')).show();
}

// Delete teacher
async function deleteTeacher(teacherId) {
    if (!confirm('Are you sure you want to delete this teacher?')) return;
    
    try {
        showLoading();
        const response = await fetch(`/api/teachers/${teacherId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Teacher deleted successfully', 'success');
            loadTeachers();
        } else {
            showToast('Error deleting teacher', 'error');
        }
    } catch (error) {
        showToast('Error deleting teacher', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Save teacher
async function saveTeacher() {
    if (!validateForm()) return;
    
    const formData = {
        name: document.getElementById('teacherName').value,
        department: document.getElementById('teacherDepartment').value
    };
    
    try {
        showLoading();
        const url = editingTeacherId ? `/api/teachers/${editingTeacherId}` : '/api/teachers';
        const method = editingTeacherId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const message = editingTeacherId ? 'Teacher updated successfully' : 'Teacher added successfully';
            showToast(message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('teacherModal')).hide();
            loadTeachers();
        } else {
            showToast('Error saving teacher', 'error');
        }
    } catch (error) {
        showToast('Error saving teacher', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Validate form
function validateForm() {
    let isValid = true;
    const fields = ['teacherName', 'teacherDepartment'];
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const value = field.value.trim();
        
        if (!value) {
            field.classList.add('is-invalid');
            field.classList.remove('is-valid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        }
    });
    
    return isValid;
}

// Reset form
function resetForm() {
    document.getElementById('teacherForm').reset();
    document.querySelectorAll('.form-control, .form-select').forEach(field => {
        field.classList.remove('is-valid', 'is-invalid');
    });
    editingTeacherId = null;
    document.getElementById('teacherModalTitle').textContent = 'Add New Teacher';
}

// Show loading
function showLoading() {
    const spinner = document.querySelector('#saveTeacherBtn .spinner');
    const btnText = document.querySelector('#saveTeacherBtn .btn-text');
    if (spinner && btnText) {
        spinner.style.display = 'inline-block';
        btnText.textContent = 'Saving...';
    }
}

// Hide loading
function hideLoading() {
    const spinner = document.querySelector('#saveTeacherBtn .spinner');
    const btnText = document.querySelector('#saveTeacherBtn .btn-text');
    if (spinner && btnText) {
        spinner.style.display = 'none';
        btnText.textContent = 'Save Teacher';
    }
}

// Show toast notification
function showToast(message, type) {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const toastHtml = `
        <div class="toast ${type}" id="${toastId}" role="alert">
            <div class="toast-header">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
</script>
{% endblock %}