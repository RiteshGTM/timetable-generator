{% extends "base.html" %}

{% block title %}Manage Time Slots - SmartTable{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Manage Time Slots</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="container-fluid">
        <h1><i class="fas fa-clock me-3"></i>Manage Time Slots</h1>
        <p>Add, edit, and manage all your time slots</p>
    </div>
</div>

<!-- Add TimeSlot Button -->
<div class="row mb-4">
    <div class="col-12">
        <button class="add-btn" data-bs-toggle="modal" data-bs-target="#timeslotModal">
            <i class="fas fa-plus"></i> Add New Time Slot
        </button>
    </div>
</div>

<!-- TimeSlots Table -->
<div class="row">
    <div class="col-12">
        <div class="data-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Period</th>
                        <th>Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="timeslotsTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Empty State -->
<div id="emptyState" class="empty-state" style="display: none;">
    <div class="icon">
        <i class="fas fa-clock"></i>
    </div>
    <h3>No Time Slots Found</h3>
    <p>Start by adding your first time slot to get started.</p>
</div>

<!-- TimeSlot Modal -->
<div class="modal fade" id="timeslotModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="timeslotModalTitle">Add New Time Slot</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="timeslotForm">
                    <div class="form-floating">
                        <select class="form-select" id="timeslotDay" required>
                            <option value="">Select Day</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                        </select>
                        <label for="timeslotDay">Day</label>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-floating">
                        <input type="number" class="form-control" id="timeslotPeriod" placeholder="Period" min="1" max="8" required>
                        <label for="timeslotPeriod">Period</label>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-floating">
                        <input type="time" class="form-control" id="startTime" placeholder="Start Time" required>
                        <label for="startTime">Start Time</label>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-floating">
                        <input type="time" class="form-control" id="endTime" placeholder="End Time" required>
                        <label for="endTime">End Time</label>
                        <div class="invalid-feedback"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTimeslotBtn">
                    <span class="spinner" style="display: none;"></span>
                    <span class="btn-text">Save Time Slot</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// Global variables
let timeslots = [];
let editingTimeslotId = null;

// Load timeslots on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTimeslots();
    
    // Form submission
    document.getElementById('saveTimeslotBtn').addEventListener('click', saveTimeslot);
    
    // Modal events
    document.getElementById('timeslotModal').addEventListener('hidden.bs.modal', resetForm);
});

// Load timeslots from API
async function loadTimeslots() {
    try {
        showLoading();
        const response = await fetch('/api/timeslots');
        timeslots = await response.json();
        renderTimeslots();
    } catch (error) {
        showToast('Error loading time slots', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Render timeslots in table
function renderTimeslots() {
    const tbody = document.getElementById('timeslotsTableBody');
    const emptyState = document.getElementById('emptyState');
    
    if (timeslots.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    tbody.innerHTML = timeslots.map(timeslot => `
        <tr>
            <td><strong>${timeslot.day}</strong></td>
            <td><span class="badge bg-primary">${timeslot.period}</span></td>
            <td><span class="badge bg-info">${timeslot.start_time} - ${timeslot.end_time}</span></td>
            <td>
                <button class="btn-edit" onclick="editTimeslot('${timeslot.id}')">
                    <i class="fas fa-edit me-1"></i>Edit
                </button>
                <button class="btn-delete" onclick="deleteTimeslot('${timeslot.id}')">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </td>
        </tr>
    `).join('');
}

// Edit timeslot
function editTimeslot(timeslotId) {
    const timeslot = timeslots.find(t => t.id === timeslotId);
    if (!timeslot) return;
    
    editingTimeslotId = timeslotId;
    document.getElementById('timeslotModalTitle').textContent = 'Edit Time Slot';
    document.getElementById('timeslotDay').value = timeslot.day;
    document.getElementById('timeslotPeriod').value = timeslot.period;
    document.getElementById('startTime').value = timeslot.start_time;
    document.getElementById('endTime').value = timeslot.end_time;
    
    new bootstrap.Modal(document.getElementById('timeslotModal')).show();
}

// Delete timeslot
async function deleteTimeslot(timeslotId) {
    if (!confirm('Are you sure you want to delete this time slot?')) return;
    
    try {
        showLoading();
        const response = await fetch(`/api/timeslots/${timeslotId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Time slot deleted successfully', 'success');
            loadTimeslots();
        } else {
            showToast('Error deleting time slot', 'error');
        }
    } catch (error) {
        showToast('Error deleting time slot', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Save timeslot
async function saveTimeslot() {
    if (!validateForm()) return;
    
    const formData = {
        day: document.getElementById('timeslotDay').value,
        period: parseInt(document.getElementById('timeslotPeriod').value),
        start_time: document.getElementById('startTime').value,
        end_time: document.getElementById('endTime').value
    };
    
    try {
        showLoading();
        const url = editingTimeslotId ? `/api/timeslots/${editingTimeslotId}` : '/api/timeslots';
        const method = editingTimeslotId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const message = editingTimeslotId ? 'Time slot updated successfully' : 'Time slot added successfully';
            showToast(message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('timeslotModal')).hide();
            loadTimeslots();
        } else {
            showToast('Error saving time slot', 'error');
        }
    } catch (error) {
        showToast('Error saving time slot', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Validate form
function validateForm() {
    let isValid = true;
    const fields = ['timeslotDay', 'timeslotPeriod', 'startTime', 'endTime'];
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const value = field.value.trim();
        
        if (!value) {
            field.classList.add('is-invalid');
            field.classList.remove('is-valid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        }
    });
    
    return isValid;
}

// Reset form
function resetForm() {
    document.getElementById('timeslotForm').reset();
    document.querySelectorAll('.form-control, .form-select').forEach(field => {
        field.classList.remove('is-valid', 'is-invalid');
    });
    editingTimeslotId = null;
    document.getElementById('timeslotModalTitle').textContent = 'Add New Time Slot';
}

// Show loading
function showLoading() {
    const spinner = document.querySelector('#saveTimeslotBtn .spinner');
    const btnText = document.querySelector('#saveTimeslotBtn .btn-text');
    if (spinner && btnText) {
        spinner.style.display = 'inline-block';
        btnText.textContent = 'Saving...';
    }
}

// Hide loading
function hideLoading() {
    const spinner = document.querySelector('#saveTimeslotBtn .spinner');
    const btnText = document.querySelector('#saveTimeslotBtn .btn-text');
    if (spinner && btnText) {
        spinner.style.display = 'none';
        btnText.textContent = 'Save Time Slot';
    }
}

// Show toast notification
function showToast(message, type) {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const toastHtml = `
        <div class="toast ${type}" id="${toastId}" role="alert">
            <div class="toast-header">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
</script>
{% endblock %}