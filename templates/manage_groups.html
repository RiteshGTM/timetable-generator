{% extends "base.html" %}

{% block title %}Manage Groups - SmartTable{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Manage Groups</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="container-fluid">
        <h1><i class="fas fa-users me-3"></i>Manage Groups</h1>
        <p>Add, edit, and manage all your student groups</p>
    </div>
</div>

<!-- Add Group Button -->
<div class="row mb-4">
    <div class="col-12">
        <button class="add-btn" data-bs-toggle="modal" data-bs-target="#groupModal">
            <i class="fas fa-plus"></i> Add New Group
        </button>
    </div>
</div>

<!-- Groups Table -->
<div class="row">
    <div class="col-12">
        <div class="data-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Group Name</th>
                        <th>Semester</th>
                        <th>Department</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="groupsTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Empty State -->
<div id="emptyState" class="empty-state" style="display: none;">
    <div class="icon">
        <i class="fas fa-users"></i>
    </div>
    <h3>No Groups Found</h3>
    <p>Start by adding your first group to get started.</p>
</div>

<!-- Group Modal -->
<div class="modal fade" id="groupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="groupModalTitle">Add New Group</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="groupForm">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="groupName" placeholder="Group Name" required>
                        <label for="groupName">Group Name</label>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-floating">
                        <select class="form-select" id="groupSemester" required>
                            <option value="">Select Semester</option>
                            <option value="1">Semester 1</option>
                            <option value="2">Semester 2</option>
                            <option value="3">Semester 3</option>
                            <option value="4">Semester 4</option>
                            <option value="5">Semester 5</option>
                            <option value="6">Semester 6</option>
                            <option value="7">Semester 7</option>
                            <option value="8">Semester 8</option>
                        </select>
                        <label for="groupSemester">Semester</label>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-floating">
                        <select class="form-select" id="groupDepartment" required>
                            <option value="">Select Department</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Mechanical">Mechanical</option>
                            <option value="Civil">Civil</option>
                        </select>
                        <label for="groupDepartment">Department</label>
                        <div class="invalid-feedback"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveGroupBtn">
                    <span class="spinner" style="display: none;"></span>
                    <span class="btn-text">Save Group</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// Global variables
let groups = [];
let editingGroupId = null;

// Load groups on page load
document.addEventListener('DOMContentLoaded', function() {
    loadGroups();
    
    // Form submission
    document.getElementById('saveGroupBtn').addEventListener('click', saveGroup);
    
    // Modal events
    document.getElementById('groupModal').addEventListener('hidden.bs.modal', resetForm);
});

// Load groups from API
async function loadGroups() {
    try {
        showLoading();
        const response = await fetch('/api/groups');
        groups = await response.json();
        renderGroups();
    } catch (error) {
        showToast('Error loading groups', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Render groups in table
function renderGroups() {
    const tbody = document.getElementById('groupsTableBody');
    const emptyState = document.getElementById('emptyState');
    
    if (groups.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    tbody.innerHTML = groups.map(group => `
        <tr>
            <td><strong>${group.name}</strong></td>
            <td><span class="badge bg-primary">Semester ${group.semester}</span></td>
            <td><span class="badge bg-info">${group.department}</span></td>
            <td>
                <button class="btn-edit" onclick="editGroup('${group.id}')">
                    <i class="fas fa-edit me-1"></i>Edit
                </button>
                <button class="btn-delete" onclick="deleteGroup('${group.id}')">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </td>
        </tr>
    `).join('');
}

// Edit group
function editGroup(groupId) {
    const group = groups.find(g => g.id === groupId);
    if (!group) return;
    
    editingGroupId = groupId;
    document.getElementById('groupModalTitle').textContent = 'Edit Group';
    document.getElementById('groupName').value = group.name;
    document.getElementById('groupSemester').value = group.semester;
    document.getElementById('groupDepartment').value = group.department;
    
    new bootstrap.Modal(document.getElementById('groupModal')).show();
}

// Delete group
async function deleteGroup(groupId) {
    if (!confirm('Are you sure you want to delete this group?')) return;
    
    try {
        showLoading();
        const response = await fetch(`/api/groups/${groupId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Group deleted successfully', 'success');
            loadGroups();
        } else {
            showToast('Error deleting group', 'error');
        }
    } catch (error) {
        showToast('Error deleting group', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Save group
async function saveGroup() {
    if (!validateForm()) return;
    
    const formData = {
        name: document.getElementById('groupName').value,
        semester: parseInt(document.getElementById('groupSemester').value),
        department: document.getElementById('groupDepartment').value
    };
    
    try {
        showLoading();
        const url = editingGroupId ? `/api/groups/${editingGroupId}` : '/api/groups';
        const method = editingGroupId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const message = editingGroupId ? 'Group updated successfully' : 'Group added successfully';
            showToast(message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('groupModal')).hide();
            loadGroups();
        } else {
            showToast('Error saving group', 'error');
        }
    } catch (error) {
        showToast('Error saving group', 'error');
        console.error('Error:', error);
    } finally {
        hideLoading();
    }
}

// Validate form
function validateForm() {
    let isValid = true;
    const fields = ['groupName', 'groupSemester', 'groupDepartment'];
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const value = field.value.trim();
        
        if (!value) {
            field.classList.add('is-invalid');
            field.classList.remove('is-valid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        }
    });
    
    return isValid;
}

// Reset form
function resetForm() {
    document.getElementById('groupForm').reset();
    document.querySelectorAll('.form-control, .form-select').forEach(field => {
        field.classList.remove('is-valid', 'is-invalid');
    });
    editingGroupId = null;
    document.getElementById('groupModalTitle').textContent = 'Add New Group';
}

// Show loading
function showLoading() {
    const spinner = document.querySelector('#saveGroupBtn .spinner');
    const btnText = document.querySelector('#saveGroupBtn .btn-text');
    if (spinner && btnText) {
        spinner.style.display = 'inline-block';
        btnText.textContent = 'Saving...';
    }
}

// Hide loading
function hideLoading() {
    const spinner = document.querySelector('#saveGroupBtn .spinner');
    const btnText = document.querySelector('#saveGroupBtn .btn-text');
    if (spinner && btnText) {
        spinner.style.display = 'none';
        btnText.textContent = 'Save Group';
    }
}

// Show toast notification
function showToast(message, type) {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const toastHtml = `
        <div class="toast ${type}" id="${toastId}" role="alert">
            <div class="toast-header">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
</script>
{% endblock %}